<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Tatuagem</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
        }
        .image-options img {
            width: 100px;
            margin-right: 10px;
            cursor: pointer;
        }
        .selected {
            border: 2px solid blue;
        }
        .admin-actions {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Formulário de Agendamento</h2>
    
    <!-- Nome -->
    <label for="nome">Nome:</label>
    <input type="text" id="nome" name="nome">

    <!-- Sobrenome -->
    <label for="sobrenome">Sobrenome:</label>
    <input type="text" id="sobrenome" name="sobrenome">

    <!-- CPF -->
    <label for="cpf">CPF:</label>
    <input type="text" id="cpf" name="cpf" onblur="verificarCPF()">

    <!-- Instagram -->
    <label for="instagram">@Instagram:</label>
    <input type="text" id="instagram" name="instagram">

    <!-- Empresa -->
    <label for="empresa">Empresa:</label>
    <input type="text" id="empresa" name="empresa">

    <!-- WhatsApp -->
    <label for="whatsapp">WhatsApp (com DDD):</label>
    <input type="text" id="whatsapp" name="whatsapp">

    <!-- Seleção de Horário -->
    <label for="horario">Selecione o horário:</label>
    <select id="horario" name="horario">
        <!-- Horários em intervalos de 20 minutos -->
    </select>

    <!-- Seleção de Imagem -->
    <label for="imagem">Selecione uma imagem:</label>
    <div class="image-options" id="image-options">
        <!-- As imagens serão inseridas aqui -->
    </div>

    <button type="submit" onclick="enviarFormulario()">Enviar</button>

    <!-- Seção de Ações Administrativas -->
    <div class="admin-actions">
        <button type="button" onclick="solicitarLogin('baixar')">Baixar Excel</button>
        <button type="button" onclick="solicitarLogin('limpar')">Limpar Dados de Agendamentos</button>
    </div>
</div>

<!-- Importar a biblioteca SheetJS para gerar o Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // Função para gerar os horários das 19:00 às 01:00 com intervalo de 20 minutos
    function gerarHorarios() {
        const select = document.getElementById('horario');
        let startTime = 19 * 60; // 19:00 em minutos
        let endTime = 1 * 60; // 01:00 do dia seguinte em minutos
        const interval = 20; // Intervalo de 20 minutos

        const agendamentos = JSON.parse(localStorage.getItem('agendamentos')) || {};

        while (startTime < 24 * 60 || startTime <= endTime) {
            let hours = Math.floor(startTime / 60);
            let minutes = startTime % 60;
            let period = hours >= 24 ? 'AM' : 'PM';
            
            if (hours >= 24) hours -= 24;

            const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

            // Verificar se o horário já atingiu o limite de 3 agendamentos
            if (!agendamentos[formattedTime] || agendamentos[formattedTime].length < 3) {
                const option = document.createElement('option');
                option.value = formattedTime;
                option.textContent = `${formattedTime} ${period}`;
                select.appendChild(option);
            }

            startTime += interval;
        }
    }

    // Carregar imagens para seleção
    function carregarImagens() {
        const imageOptions = document.getElementById('image-options');
        const imagens = ['imagem1.jpg', 'imagem2.jpg', 'imagem3.jpg']; // Substitua com os caminhos das suas imagens
        
        imagens.forEach((imagem, index) => {
            const imgElement = document.createElement('img');
            imgElement.src = imagem;
            imgElement.alt = `Imagem ${index + 1}`;
            imgElement.onclick = () => selecionarImagem(imgElement);
            imageOptions.appendChild(imgElement);
        });
    }

    // Função para selecionar uma imagem
    function selecionarImagem(imgElement) {
        const imagens = document.querySelectorAll('.image-options img');
        imagens.forEach(img => img.classList.remove('selected'));
        imgElement.classList.add('selected');
    }

    // Função para salvar os dados em localStorage e verificar o limite de 3 atendimentos por horário
    function enviarFormulario() {
        const nome = document.getElementById('nome').value;
        const sobrenome = document.getElementById('sobrenome').value;
        const cpf = document.getElementById('cpf').value;
        const instagram = document.getElementById('instagram').value;
        const empresa = document.getElementById('empresa').value;
        const whatsapp = document.getElementById('whatsapp').value;
        const horario = document.getElementById('horario').value;
        const imagemSelecionada = document.querySelector('.image-options .selected')?.src;

        // Verificar duplicidade de CPF
        let agendamentos = JSON.parse(localStorage.getItem('agendamentos')) || {};
        for (const horarioAgendado in agendamentos) {
            if (agendamentos[horarioAgendado].some(agendamento => agendamento.cpf === cpf)) {
                alert('Este CPF já possui um agendamento.');
                return;
            }
        }

        // Verificar se o horário já tem 3 atendimentos
        if (!agendamentos[horario]) {
            agendamentos[horario] = [];
        }

        if (agendamentos[horario].length >= 3) {
            alert('Este horário já atingiu o limite de 3 atendimentos.');
            return;
        }

        // Adicionar os dados do novo agendamento
        agendamentos[horario].push({
            nome, sobrenome, cpf, instagram, empresa, whatsapp, imagemSelecionada
        });

        localStorage.setItem('agendamentos', JSON.stringify(agendamentos));

        alert('Formulário enviado com sucesso!');
        // Atualizar a lista de horários após o envio
        atualizarHorarios();
    }

    // Função para verificar duplicidade de CPF durante o preenchimento
    function verificarCPF() {
        const cpf = document.getElementById('cpf').value;
        const agendamentos = JSON.parse(localStorage.getItem('agendamentos')) || {};

        for (const horarioAgendado in agendamentos) {
            if (agendamentos[horarioAgendado].some(agendamento => agendamento.cpf === cpf)) {
                alert('Este CPF já foi usado para um agendamento.');
                break;
            }
        }
    }

    // Função para gerar o arquivo Excel com os dados
    function baixarExcel() {
        const agendamentos = JSON.parse(localStorage.getItem('agendamentos')) || {};

        // Preparar os dados para o Excel
        let dadosExcel = [['Nome', 'Sobrenome', 'CPF', 'Instagram', 'Empresa', 'WhatsApp', 'Horário', 'Imagem']];
        for (const horario in agendamentos) {
            agendamentos[horario].forEach((agendamento) => {
                dadosExcel.push([agendamento.nome, agendamento.sobrenome, agendamento.cpf, agendamento.instagram, agendamento.empresa, agendamento.whatsapp, horario, agendamento.imagemSelecionada]);
            });
        }

        // Criar uma planilha
        const ws = XLSX.utils.aoa_to_sheet(dadosExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Agendamentos');

        // Baixar o arquivo Excel
        XLSX.writeFile(wb, 'agendamentos.xlsx');
    }

    // Função para limpar todos os dados do agendamento
    function limparDados() {
        if (confirm("Tem certeza que deseja limpar todos os dados de agendamentos?")) {
            localStorage.clear();  // Limpa todos os dados armazenados no localStorage
            alert('Todos os dados de agendamentos foram limpos.');
            atualizarHorarios(); //
            atualizarHorarios(); // Atualiza a lista de horários para exibir todos novamente
        }
    }

    // Função para solicitar login antes de permitir certas ações (baixar Excel ou limpar dados)
    function solicitarLogin(acao) {
        const login = prompt("Digite o login:");
        const senha = prompt("Digite a senha:");

        if (login === 'admin' && senha === 'Glauber2019') {
            if (acao === 'baixar') {
                baixarExcel();
            } else if (acao === 'limpar') {
                limparDados();
            }
        } else {
            alert("Login ou senha incorretos. Ação não autorizada.");
        }
    }

    // Função para atualizar a lista de horários ao enviar um formulário
    function atualizarHorarios() {
        const select = document.getElementById('horario');
        // Limpar as opções existentes
        select.innerHTML = '';
        // Regenerar os horários disponíveis
        gerarHorarios();
    }

    // Carregar horários e imagens ao carregar a página
    window.onload = () => {
        gerarHorarios();
        carregarImagens();
    };
</script>

</body>
</html>
